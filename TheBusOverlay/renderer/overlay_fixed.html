<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheBus Live Dashboard - Full Custom</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            color: #fff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        /* Hintergrund nur wenn aktiviert */
        body.show-bg {
            background-image: url('actions/assets/vorschau.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* OBS Mode: Kein Hintergrund, nur transparent */
        body.obs-mode {
            background-image: none !important;
            background: transparent !important;
        }

        /* Resolution Info */
        .resolution-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(20, 20, 30, 0.9);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid rgba(102, 126, 234, 0.5);
        }

        body:hover .resolution-info {
            opacity: 1;
        }

        body.obs-mode .resolution-info {
            display: none;
        }

        .resolution-info.correct {
            border-color: rgba(76, 175, 80, 0.8);
            color: #4ade80;
        }

        .resolution-info.wrong {
            border-color: rgba(255, 150, 0, 0.8);
            color: #ffaa00;
        }

        /* OBS Mode: Keine Controls sichtbar */
        body.obs-mode .control-btn,
        body.obs-mode .settings-panel {
            display: none !important;
        }

        /* Control Buttons - Im OBS Mode versteckt */
        .control-btn {
            position: fixed;
            z-index: 9999;
            background: rgba(102, 126, 234, 0.9);
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
        }

        body:hover .control-btn {
            opacity: 0.3;
            pointer-events: all;
        }

        .control-btn:hover {
            opacity: 1 !important;
            transform: scale(1.05);
        }

        /* OBS Mode Indicator */
        .mode-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(76, 175, 80, 0.8);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        body:hover .mode-indicator {
            opacity: 1;
        }

        body.obs-mode .mode-indicator {
            display: none;
        }

        /* OBS Info Box */
        .obs-info-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(102, 126, 234, 0.6);
            border-radius: 12px;
            padding: 25px;
            max-width: 700px;
            z-index: 10001;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            display: none;
        }

        .obs-info-box.show {
            display: block;
        }

        body.obs-mode .obs-info-box {
            display: none !important;
        }

        .obs-info-box h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .obs-info-box p {
            margin: 10px 0;
            line-height: 1.6;
            font-size: 13px;
            opacity: 0.9;
        }

        .obs-url-container {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid rgba(102, 126, 234, 0.3);
            max-height: 200px;
            overflow-y: auto;
        }

        .obs-url-container::-webkit-scrollbar {
            width: 6px;
        }

        .obs-url-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }

        .obs-url-container::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.6);
            border-radius: 3px;
        }

        .obs-url-container::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        .obs-url {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 11px;
            color: #4ade80;
            word-break: break-all;
            user-select: all;
        }

        .copy-btn {
            background: rgba(102, 126, 234, 0.9);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            font-size: 12px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: rgba(76, 175, 80, 0.9);
        }

        .close-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 70, 70, 0.8);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .close-info-btn:hover {
            background: rgba(255, 70, 70, 1);
            transform: rotate(90deg);
        }

        #editModeBtn {
            top: 10px;
            right: 10px;
        }

        #editModeBtn.active {
            background: rgba(255, 100, 100, 0.9);
            opacity: 1;
        }

        #resetLayoutBtn {
            top: 10px;
            right: 150px;
            background: rgba(255, 150, 0, 0.9);
        }

        #saveAndShowBtn {
            top: 10px;
            right: 310px;
            background: rgba(76, 175, 80, 0.9);
        }

        #settingsBtn {
            bottom: 10px;
            right: 10px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            padding: 0;
            font-size: 24px;
        }

        #selectAllBtn {
            top: 10px;
            left: 10px;
            background: rgba(0, 200, 100, 0.9);
        }

        #hideAllBtn {
            top: 10px;
            left: 150px;
            background: rgba(200, 50, 50, 0.9);
        }

        #toggleBgBtn {
            top: 10px;
            left: 310px;
            background: rgba(150, 100, 200, 0.9);
        }

        #toggleBgBtn.active {
            background: rgba(100, 200, 150, 0.9);
        }

        /* Data Item (individual draggable widget) */
        .data-item {
            position: absolute;
            background: rgba(15, 15, 25, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            padding: 8px 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            transition: box-shadow 0.3s, border 0.3s;
            cursor: default;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            resize: both;
            overflow: hidden;
            z-index: 10;
        }

        /* Borderless Item: Nur Text + Emoji */
        .data-item.borderless-item,
        .door-widget.borderless-item {
            background: transparent !important;
            backdrop-filter: none !important;
            border: none !important;
            box-shadow: none !important;
            padding: 4px 8px;
        }

        /* Borderless UMG Displays: Header verstecken */
        .umg-display-widget.borderless-item .umg-header {
            display: none;
        }

        .umg-display-widget.borderless-item .umg-image {
            height: 100%;
        }

        .data-item.borderless-item.edit-mode,
        .door-widget.borderless-item.edit-mode {
            border: 1px dashed rgba(102, 126, 234, 0.3) !important;
            background: rgba(102, 126, 234, 0.05) !important;
        }

        /* Toggle Border Button (on each item) */
        .toggle-border-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(102, 126, 234, 0.8);
            border: none;
            border-radius: 3px;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
        }

        /* Eye Toggle Button (on each item) */
        .toggle-eye-btn {
            position: absolute;
            top: 2px;
            right: 30px;
            background: rgba(76, 175, 80, 0.8);
            border: none;
            border-radius: 3px;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .toggle-eye-btn.hidden-item {
            background: rgba(200, 50, 50, 0.8);
        }

        /* Z-Index Buttons */
        .z-index-up-btn {
            position: absolute;
            top: 24px;
            right: 2px;
            background: rgba(255, 180, 0, 0.8);
            border: none;
            border-radius: 3px;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .z-index-down-btn {
            position: absolute;
            top: 24px;
            right: 30px;
            background: rgba(150, 150, 150, 0.8);
            border: none;
            border-radius: 3px;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .data-item:hover .toggle-border-btn,
        .data-item:hover .toggle-eye-btn,
        .data-item:hover .z-index-up-btn,
        .data-item:hover .z-index-down-btn,
        .door-widget:hover .toggle-border-btn,
        .door-widget:hover .toggle-eye-btn,
        .door-widget:hover .z-index-up-btn,
        .door-widget:hover .z-index-down-btn {
            opacity: 1;
        }

        .toggle-border-btn:hover {
            background: rgba(102, 126, 234, 1);
        }

        .toggle-eye-btn:hover {
            background: rgba(76, 175, 80, 1);
        }

        .toggle-eye-btn.hidden-item:hover {
            background: rgba(200, 50, 50, 1);
        }

        .z-index-up-btn:hover {
            background: rgba(255, 180, 0, 1);
        }

        .z-index-down-btn:hover {
            background: rgba(150, 150, 150, 1);
        }

        body.obs-mode .toggle-border-btn,
        body.obs-mode .toggle-eye-btn,
        body.obs-mode .z-index-up-btn,
        body.obs-mode .z-index-down-btn {
            display: none !important;
        }

        /* Hidden items in OBS mode */
        body.obs-mode .data-item.hidden-by-eye,
        body.obs-mode .door-widget.hidden-by-eye {
            display: none !important;
        }

        /* In edit mode: show with low opacity */
        .data-item.hidden-by-eye,
        .door-widget.hidden-by-eye {
            opacity: 0.3;
        }

        .data-item.edit-mode {
            resize: both;
            cursor: move !important;
        }

        .data-item.hidden {
            display: none !important;
        }

        .data-item.dragging {
            opacity: 0.7;
            cursor: move;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
            border: 2px solid rgba(102, 126, 234, 0.8);
        }

        .data-item.edit-mode {
            cursor: move;
            border: 2px dashed rgba(102, 126, 234, 0.5);
        }

        .data-item.edit-mode:hover {
            border: 2px dashed rgba(102, 126, 234, 1);
            background: rgba(15, 15, 25, 0.85);
            box-shadow: 0 4px 25px rgba(102, 126, 234, 0.4);
        }

        .data-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .data-content {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .data-label {
            font-size: 9px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-value {
            font-size: 13px;
            font-weight: bold;
            margin-top: 2px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-value.warning {
            color: #ffaa00;
        }

        .data-value.danger {
            color: #ff4444;
        }

        .data-value.success {
            color: #00ff88;
        }

        /* Door Widget (special case) */
        .door-widget {
            position: absolute;
            background: rgba(15, 15, 25, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
            min-width: 100px;
            min-height: 80px;
            overflow: auto;
            z-index: 10;
        }

        .door-widget.edit-mode {
            cursor: move !important;
            border: 2px dashed rgba(102, 126, 234, 0.5);
            resize: both;
        }

        .door-widget.edit-mode:hover {
            border: 2px dashed rgba(102, 126, 234, 1);
            background: rgba(15, 15, 25, 0.85);
        }

        .door-item {
            text-align: center;
            padding: 6px;
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(6px);
            border-radius: 4px;
            margin-bottom: 6px;
        }

        .door-item:last-child {
            margin-bottom: 0;
        }

        .door-label {
            font-size: 9px;
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .door-value {
            font-size: 12px;
            font-weight: bold;
        }

        .door-bar {
            height: 3px;
            background: #00ff88;
            border-radius: 2px;
            margin-top: 3px;
            transition: width 0.3s;
        }

        /* Settings Panel */
        .settings-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 12px;
            padding: 20px;
            z-index: 10000;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
        }

        .settings-header {
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .setting-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .setting-item input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .settings-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save {
            background: #00aa00;
            color: #fff;
        }

        .btn-save:hover {
            background: #00cc00;
        }

        .btn-cancel {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        .btn-cancel:hover {
            background: rgba(255,255,255,0.3);
        }

        .door-count-select {
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            font-size: 14px;
        }

        /* Scrollbar */
        .settings-panel::-webkit-scrollbar {
            width: 8px;
        }

        .settings-panel::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }

        .settings-panel::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.6);
            border-radius: 4px;
        }

        .settings-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        /* UMG Display Widget */
        .umg-display-widget {
            background: rgba(15, 15, 25, 0.85) !important;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .umg-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.9);
        }

        .umg-header .data-icon {
            font-size: 14px;
        }

        .umg-header .data-label {
            font-weight: 600;
        }

        .umg-image {
            width: 100%;
            height: calc(100% - 30px);
            object-fit: contain;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- OBS Info Box (only visible after clicking "Speichern & URL anzeigen") -->
    <div class="obs-info-box" id="obsInfoBox">
        <button class="close-info-btn" onclick="document.getElementById('obsInfoBox').classList.remove('show')">√ó</button>
        <h3>üìπ OBS Browser Source Setup</h3>
        <p><strong>‚ú® SO EINFACH:</strong></p>
        <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
            <li>Verschiebe Felder wie du willst</li>
            <li>Klicke "üìã URL Kopieren" (enth√§lt dein Layout!)</li>
            <li>Paste in OBS Browser Source</li>
        </ol>
        <div class="obs-url-container">
            <div class="obs-url" id="obsUrl">Loading...</div>
        </div>
        <button class="copy-btn" id="copyUrlBtn">üìã URL Kopieren</button>
        <p style="margin-top: 15px; font-size: 11px; opacity: 0.7;">
            üí° <strong>So funktioniert's:</strong><br>
            ‚Üí Layout wird in der URL gespeichert (im #hash)<br>
            ‚Üí Wenn du die URL kopierst, ist das Layout drin!<br>
            ‚Üí OBS liest das Layout aus der URL<br>
            <br>
            üéØ <strong>OBS Settings:</strong><br>
            ‚úÖ Breite: 1920 | H√∂he: 1080<br>
            ‚úÖ "Refresh browser when scene becomes active"
        </p>
    </div>

    <!-- Control Buttons -->
    <button class="control-btn" id="editModeBtn">üîí Edit Mode: AUS</button>
    <button class="control-btn" id="resetLayoutBtn">‚Ü∫ Layout Reset</button>
    <button class="control-btn" id="saveAndShowBtn">üíæ Speichern & URL anzeigen</button>
    <button class="control-btn" id="selectAllBtn">‚òëÔ∏è Alle zeigen</button>
    <button class="control-btn" id="hideAllBtn">‚òê Alle verstecken</button>
    <button class="control-btn" id="toggleBgBtn">üñºÔ∏è Hintergrund: AUS</button>
    <button class="control-btn" id="settingsBtn">‚öôÔ∏è</button>

    <!-- Resolution Info -->
    <div class="resolution-info" id="resolutionInfo">Lade...</div>

    <!-- Doors Widget -->
    <div class="door-widget" id="widget_doors" data-widget="doors" style="top: 10px; left: 10px;">
        <button class="toggle-border-btn" onclick="toggleItemBorder('widget_doors')">üìã</button>
        <div id="doorsContainer"></div>
    </div>

    <!-- Individual Data Items -->
    <div class="data-item" id="item_speed" data-field="speed" style="top: 10px; left: 200px;">
        <div class="data-icon">üèéÔ∏è</div>
        <div class="data-content">
            <div class="data-label">Speed</div>
            <div class="data-value" id="value_speed">0 km/h</div>
        </div>
    </div>

    <div class="data-item" id="item_gear" data-field="gear" style="top: 10px; left: 360px;">
        <div class="data-icon">‚öôÔ∏è</div>
        <div class="data-content">
            <div class="data-label">Gang</div>
            <div class="data-value" id="value_gear">N</div>
        </div>
    </div>

    <div class="data-item" id="item_fuel" data-field="fuel" style="top: 10px; left: 520px;">
        <div class="data-icon">‚õΩ</div>
        <div class="data-content">
            <div class="data-label">Kraftstoff</div>
            <div class="data-value" id="value_fuel">0%</div>
        </div>
    </div>

    <div class="data-item" id="item_passengers" data-field="passengers" style="top: 10px; left: 680px;">
        <div class="data-icon">üë•</div>
        <div class="data-content">
            <div class="data-label">Passagiere</div>
            <div class="data-value" id="value_passengers">0</div>
        </div>
    </div>

    <div class="data-item" id="item_model" data-field="model" style="top: 70px; left: 200px;">
        <div class="data-icon">üöå</div>
        <div class="data-content">
            <div class="data-label">Modell</div>
            <div class="data-value" id="value_model">-</div>
        </div>
    </div>

    <div class="data-item" id="item_rpm" data-field="rpm" style="top: 130px; left: 10px;">
        <div class="data-icon">‚ö°</div>
        <div class="data-content">
            <div class="data-label">Drehzahl</div>
            <div class="data-value" id="value_rpm">0 RPM</div>
        </div>
    </div>

    <div class="data-item" id="item_temp" data-field="temp" style="top: 130px; left: 200px;">
        <div class="data-icon">üå°Ô∏è</div>
        <div class="data-content">
            <div class="data-label">Motor Temp</div>
            <div class="data-value" id="value_temp">0¬∞C</div>
        </div>
    </div>

    <div class="data-item" id="item_brake" data-field="brake" style="top: 130px; left: 360px;">
        <div class="data-icon">üö´</div>
        <div class="data-content">
            <div class="data-label">Bremse</div>
            <div class="data-value" id="value_brake">0%</div>
        </div>
    </div>

    <div class="data-item" id="item_throttle" data-field="throttle" style="top: 130px; left: 520px;">
        <div class="data-icon">‚ö°</div>
        <div class="data-content">
            <div class="data-label">Gas</div>
            <div class="data-value" id="value_throttle">0%</div>
        </div>
    </div>

    <div class="data-item" id="item_steering" data-field="steering" style="top: 130px; left: 680px;">
        <div class="data-icon">üéØ</div>
        <div class="data-content">
            <div class="data-label">Lenkung</div>
            <div class="data-value" id="value_steering">0¬∞</div>
        </div>
    </div>

    <div class="data-item" id="item_load" data-field="load" style="top: 190px; left: 10px;">
        <div class="data-icon">üë•</div>
        <div class="data-content">
            <div class="data-label">Passagiere %</div>
            <div class="data-value" id="value_load">0%</div>
        </div>
    </div>

    <div class="data-item" id="item_atstop" data-field="atstop" style="top: 190px; left: 200px;">
        <div class="data-icon">üöè</div>
        <div class="data-content">
            <div class="data-label">Haltestelle</div>
            <div class="data-value" id="value_atstop">NEIN</div>
        </div>
    </div>

    <div class="data-item" id="item_indicator" data-field="indicator" style="top: 190px; left: 360px;">
        <div class="data-icon">‚¨ÖÔ∏è</div>
        <div class="data-content">
            <div class="data-label">Blinker</div>
            <div class="data-value" id="value_indicator">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_wiper" data-field="wiper" style="top: 190px; left: 520px;">
        <div class="data-icon">üåßÔ∏è</div>
        <div class="data-content">
            <div class="data-label">Wischer</div>
            <div class="data-value" id="value_wiper">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_headlights" data-field="headlights" style="top: 250px; left: 10px;">
        <div class="data-icon">üí°</div>
        <div class="data-content">
            <div class="data-label">Abblendlicht</div>
            <div class="data-value" id="value_headlights">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_highbeam" data-field="highbeam" style="top: 250px; left: 200px;">
        <div class="data-icon">üîÜ</div>
        <div class="data-content">
            <div class="data-label">Fernlicht</div>
            <div class="data-value" id="value_highbeam">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_interior" data-field="interior" style="top: 250px; left: 360px;">
        <div class="data-icon">üè†</div>
        <div class="data-content">
            <div class="data-label">Innenraum</div>
            <div class="data-value" id="value_interior">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_hazard" data-field="hazard" style="top: 250px; left: 520px;">
        <div class="data-icon">‚ö†Ô∏è</div>
        <div class="data-content">
            <div class="data-label">Warnblinker</div>
            <div class="data-value" id="value_hazard">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_ignition" data-field="ignition" style="top: 310px; left: 10px;">
        <div class="data-icon">üîë</div>
        <div class="data-content">
            <div class="data-label">Z√ºndung</div>
            <div class="data-value" id="value_ignition">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_retarder" data-field="retarder" style="top: 310px; left: 200px;">
        <div class="data-icon">üîÑ</div>
        <div class="data-content">
            <div class="data-label">Retarder</div>
            <div class="data-value" id="value_retarder">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_parkbrake" data-field="parkbrake" style="top: 310px; left: 360px;">
        <div class="data-icon">üÖøÔ∏è</div>
        <div class="data-content">
            <div class="data-label">Feststellbremse</div>
            <div class="data-value" id="value_parkbrake">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_cruisecontrol" data-field="cruisecontrol" style="top: 310px; left: 520px;">
        <div class="data-icon">üéØ</div>
        <div class="data-content">
            <div class="data-label">Tempomat</div>
            <div class="data-value" id="value_cruisecontrol">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_lowfuel" data-field="lowfuel" style="top: 310px; left: 680px;">
        <div class="data-icon">‚õΩ</div>
        <div class="data-content">
            <div class="data-label">Fuel Warnung</div>
            <div class="data-value" id="value_lowfuel">NEIN</div>
        </div>
    </div>

    <div class="data-item" id="item_destination" data-field="destination" style="top: 370px; left: 10px;">
        <div class="data-icon">üìã</div>
        <div class="data-content">
            <div class="data-label">Zielanzeige</div>
            <div class="data-value" id="value_destination">AUS</div>
        </div>
    </div>

    <!-- NEW: Fahrzeug-Info -->
    <div class="data-item" id="item_allowedspeed" data-field="allowedspeed" style="top: 70px; left: 360px;">
        <div class="data-icon">üö¶</div>
        <div class="data-content">
            <div class="data-label">Tempolimit</div>
            <div class="data-value" id="value_allowedspeed">50 km/h</div>
        </div>
    </div>

    <div class="data-item" id="item_mass" data-field="mass" style="top: 70px; left: 520px;">
        <div class="data-icon">‚öñÔ∏è</div>
        <div class="data-content">
            <div class="data-label">Gewicht</div>
            <div class="data-value" id="value_mass">14000 kg</div>
        </div>
    </div>

    <div class="data-item" id="item_numseats" data-field="numseats" style="top: 70px; left: 680px;">
        <div class="data-icon">üí∫</div>
        <div class="data-content">
            <div class="data-label">Sitzpl√§tze</div>
            <div class="data-value" id="value_numseats">30</div>
        </div>
    </div>

    <div class="data-item" id="item_dirtintensity" data-field="dirtintensity" style="top: 430px; left: 10px;">
        <div class="data-icon">üíß</div>
        <div class="data-content">
            <div class="data-label">Verschmutzung</div>
            <div class="data-value" id="value_dirtintensity">0%</div>
        </div>
    </div>

    <!-- NEW: Motor & Technik -->
    <div class="data-item" id="item_enginestarted" data-field="enginestarted" style="top: 430px; left: 200px;">
        <div class="data-icon">üîë</div>
        <div class="data-content">
            <div class="data-label">Motor Status</div>
            <div class="data-value" id="value_enginestarted">AUS</div>
        </div>
    </div>

    <div class="data-item" id="item_maxrpm" data-field="maxrpm" style="top: 430px; left: 360px;">
        <div class="data-icon">üìà</div>
        <div class="data-content">
            <div class="data-label">Max RPM</div>
            <div class="data-value" id="value_maxrpm">11000</div>
        </div>
    </div>

    <div class="data-item" id="item_powermeter" data-field="powermeter" style="top: 430px; left: 520px;">
        <div class="data-icon">üîã</div>
        <div class="data-content">
            <div class="data-label">Motorlast</div>
            <div class="data-value" id="value_powermeter">0%</div>
        </div>
    </div>

    <!-- UMG Display Widget -->
    <div class="data-item umg-display-widget" id="item_umgdisplay" data-field="umgdisplay" style="top: 490px; left: 10px; width: 300px; height: 360px;">
        <div class="umg-header">
            <div class="data-icon">üì∫</div>
            <div class="data-label">Fahrer Display</div>
        </div>
        <img id="umg_image" class="umg-image" src="" alt="Warte auf Display...">
    </div>

    <!-- ATRON Boardcomputer Widget -->
    <div class="data-item umg-display-widget" id="item_atron" data-field="atron" style="top: 490px; left: 320px; width: 400px; height: 360px;">
        <div class="umg-header">
            <div class="data-icon">üí≥</div>
            <div class="data-label">ATRON Bordcomputer</div>
        </div>
        <img id="atron_image" class="umg-image" src="" alt="Warte auf ATRON...">
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">‚öôÔ∏è Overlay Einstellungen</div>
        
        <div class="settings-section">
            <h4>T√ºranzahl</h4>
            <select class="door-count-select" id="doorCountSelect">
                <option value="2">2 T√ºren</option>
                <option value="3" selected>3 T√ºren</option>
                <option value="4">4 T√ºren</option>
            </select>
        </div>

        <div class="settings-section">
            <h4>üö™ T√ºren & Fahrzeug</h4>
            <div class="settings-grid">
                <label class="setting-item"><input type="checkbox" id="field_doors" checked> üö™ T√ºren</label>
                <label class="setting-item"><input type="checkbox" id="field_speed" checked> üèéÔ∏è Speed</label>
                <label class="setting-item"><input type="checkbox" id="field_gear" checked> ‚öôÔ∏è Gang</label>
                <label class="setting-item"><input type="checkbox" id="field_fuel" checked> ‚õΩ Fuel</label>
                <label class="setting-item"><input type="checkbox" id="field_passengers" checked> üë• Passagiere</label>
                <label class="setting-item"><input type="checkbox" id="field_model" checked> üöå Modell</label>
                <label class="setting-item"><input type="checkbox" id="field_allowedspeed" checked> üö¶ Tempolimit</label>
                <label class="setting-item"><input type="checkbox" id="field_mass" checked> ‚öñÔ∏è Gewicht</label>
                <label class="setting-item"><input type="checkbox" id="field_numseats" checked> üí∫ Sitzpl√§tze</label>
                <label class="setting-item"><input type="checkbox" id="field_dirtintensity" checked> üíß Verschmutzung</label>
            </div>
        </div>

        <div class="settings-section">
            <h4>üîß Motor & Steuerung</h4>
            <div class="settings-grid">
                <label class="setting-item"><input type="checkbox" id="field_rpm" checked> ‚ö° RPM</label>
                <label class="setting-item"><input type="checkbox" id="field_temp" checked> üå°Ô∏è Temp</label>
                <label class="setting-item"><input type="checkbox" id="field_brake" checked> üö´ Bremse</label>
                <label class="setting-item"><input type="checkbox" id="field_throttle" checked> ‚ö° Gas</label>
                <label class="setting-item"><input type="checkbox" id="field_steering" checked> üéØ Lenkung</label>
                <label class="setting-item"><input type="checkbox" id="field_load" checked> üë• Passagiere %</label>
                <label class="setting-item"><input type="checkbox" id="field_enginestarted" checked> üîë Motor Status</label>
                <label class="setting-item"><input type="checkbox" id="field_maxrpm" checked> üìà Max RPM</label>
                <label class="setting-item"><input type="checkbox" id="field_powermeter" checked> üîã Motorlast</label>
            </div>
        </div>

        <div class="settings-section">
            <h4>üö¶ Info & Wischer</h4>
            <div class="settings-grid">
                <label class="setting-item"><input type="checkbox" id="field_atstop" checked> üöè Haltestelle</label>
                <label class="setting-item"><input type="checkbox" id="field_indicator" checked> ‚¨ÖÔ∏è Blinker</label>
                <label class="setting-item"><input type="checkbox" id="field_wiper" checked> üåßÔ∏è Wischer</label>
                <label class="setting-item"><input type="checkbox" id="field_umgdisplay" checked> üì∫ Fahrer Display</label>
                <label class="setting-item"><input type="checkbox" id="field_atron" checked> üí≥ ATRON</label>
            </div>
        </div>

        <div class="settings-section">
            <h4>üí° Beleuchtung</h4>
            <div class="settings-grid">
                <label class="setting-item"><input type="checkbox" id="field_headlights" checked> üí° Abblend</label>
                <label class="setting-item"><input type="checkbox" id="field_highbeam" checked> üîÜ Fernlicht</label>
                <label class="setting-item"><input type="checkbox" id="field_interior" checked> üè† Innenraum</label>
                <label class="setting-item"><input type="checkbox" id="field_hazard" checked> ‚ö†Ô∏è Warnblinker</label>
            </div>
        </div>

        <div class="settings-section">
            <h4>üü¢ Status & Warnungen</h4>
            <div class="settings-grid">
                <label class="setting-item"><input type="checkbox" id="field_ignition" checked> üîë Z√ºndung</label>
                <label class="setting-item"><input type="checkbox" id="field_retarder" checked> üîÑ Retarder</label>
                <label class="setting-item"><input type="checkbox" id="field_parkbrake" checked> üÖøÔ∏è Feststellbr.</label>
                <label class="setting-item"><input type="checkbox" id="field_cruisecontrol" checked> üéØ Tempomat</label>
                <label class="setting-item"><input type="checkbox" id="field_lowfuel" checked> ‚õΩ Fuel Warn</label>
                <label class="setting-item"><input type="checkbox" id="field_destination" checked> üìã Zielanzeige</label>
            </div>
        </div>

        <div class="settings-actions">
            <button class="btn btn-save" id="saveBtn">‚úì Speichern</button>
            <button class="btn btn-cancel" id="cancelBtn">‚úï Abbrechen</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:37337';
        let currentVehicle = null;
        let lastUpdate = 0;
        let updateInterval = null;
        let editMode = false;

        // Cookie Helper (works across browser instances!)
        function setCookie(name, value, days = 365) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }

        // Drag & Drop
        let draggedElement = null;
        let offsetX = 0;
        let offsetY = 0;

        const fields = [
            'doors', 'speed', 'gear', 'fuel', 'passengers', 'model',
            'rpm', 'temp', 'brake', 'throttle', 'steering', 'load',
            'atstop', 'indicator', 'wiper',
            'headlights', 'highbeam', 'interior', 'hazard',
            'ignition', 'retarder', 'parkbrake', 'cruisecontrol', 'lowfuel', 'destination',
            'allowedspeed', 'mass', 'numseats', 'dirtintensity',
            'enginestarted', 'maxrpm', 'powermeter', 'umgdisplay', 'atron'
        ];

        // Edit Mode Toggle
        document.getElementById('editModeBtn').addEventListener('click', () => {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            const items = document.querySelectorAll('.data-item, .door-widget');
            
            if (editMode) {
                btn.textContent = '‚úì Edit Mode: AN';
                btn.classList.add('active');
                items.forEach(w => w.classList.add('edit-mode'));
            } else {
                btn.textContent = 'üîí Edit Mode: AUS';
                btn.classList.remove('active');
                items.forEach(w => w.classList.remove('edit-mode'));
            }
        });

        // Save and Show URL Button
        document.getElementById('saveAndShowBtn').addEventListener('click', () => {
            saveLayout();
            
            // Update URL in info box
            const currentPath = window.location.href.split('?')[0].split('#')[0];
            const currentHash = window.location.hash || '';
            const obsUrl = currentPath + '?obs=true' + currentHash;
            document.getElementById('obsUrl').textContent = obsUrl;
            
            // Show info box
            document.getElementById('obsInfoBox').classList.add('show');
        });

        // Reset Layout
        document.getElementById('resetLayoutBtn').addEventListener('click', () => {
            if (confirm('Layout auf Standardwerte zur√ºcksetzen?')) {
                localStorage.removeItem('itemPositions');
                location.reload();
            }
        });

        // Toggle Background
        let showBackground = localStorage.getItem('showBackground') === 'true';
        document.getElementById('toggleBgBtn').addEventListener('click', () => {
            showBackground = !showBackground;
            localStorage.setItem('showBackground', showBackground);
            const btn = document.getElementById('toggleBgBtn');
            
            if (showBackground) {
                document.body.classList.add('show-bg');
                btn.textContent = 'üñºÔ∏è Hintergrund: AN';
                btn.classList.add('active');
            } else {
                document.body.classList.remove('show-bg');
                btn.textContent = 'üñºÔ∏è Hintergrund: AUS';
                btn.classList.remove('active');
            }
        });

        // Toggle Individual Item Border
        function toggleItemBorder(itemId) {
            const item = document.getElementById(itemId);
            if (!item) return;
            
            item.classList.toggle('borderless-item');
            saveLayout(); // Save to URL hash immediately!
        }

        // Toggle Individual Item Visibility
        function toggleItemVisibility(itemId) {
            const item = document.getElementById(itemId);
            if (!item) return;
            
            const isHidden = item.classList.toggle('hidden-by-eye');
            const eyeBtn = item.querySelector('.toggle-eye-btn');
            if (eyeBtn) {
                eyeBtn.textContent = isHidden ? 'üö´' : 'üëÅÔ∏è';
                eyeBtn.classList.toggle('hidden-item', isHidden);
            }
            saveLayout(); // Save to URL hash immediately!
        }

        // Move item up in Z-Index (to front)
        function moveItemUp(itemId) {
            const item = document.getElementById(itemId);
            if (!item) return;
            
            const currentZ = parseInt(item.style.zIndex) || 10;
            item.style.zIndex = currentZ + 1;
            saveLayout();
        }

        // Move item down in Z-Index (to back)
        function moveItemDown(itemId) {
            const item = document.getElementById(itemId);
            if (!item) return;
            
            const currentZ = parseInt(item.style.zIndex) || 10;
            item.style.zIndex = Math.max(1, currentZ - 1);
            saveLayout();
        }

        // Load borderless states
        function loadBorderlessStates() {
            // This is now handled by loadLayout() which reads from URL hash
            // Keeping this function for backward compatibility with localStorage
            document.querySelectorAll('.data-item, .door-widget').forEach(item => {
                const isBorderless = localStorage.getItem(`borderless_${item.id}`) === 'true';
                if (isBorderless && !item.classList.contains('borderless-item')) {
                    item.classList.add('borderless-item');
                }
            });
        }

        // Update Resolution Info
        function updateResolutionInfo() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const isCorrect = width === 1920 && height === 1080;
            const info = document.getElementById('resolutionInfo');
            
            info.textContent = `${width}x${height}${isCorrect ? ' ‚úÖ PERFEKT' : ' ‚ö†Ô∏è OBS = 1920x1080'}`;
            info.className = 'resolution-info ' + (isCorrect ? 'correct' : 'wrong');
        }

        window.addEventListener('resize', updateResolutionInfo);

        // Select All
        document.getElementById('selectAllBtn').addEventListener('click', () => {
            fields.forEach(field => {
                const checkbox = document.getElementById(`field_${field}`);
                if (checkbox) checkbox.checked = true;
            });
            const newSettings = {};
            fields.forEach(field => {
                const checkbox = document.getElementById(`field_${field}`);
                newSettings[field] = checkbox ? checkbox.checked : true;
            });
            newSettings.doorCount = document.getElementById('doorCountSelect').value;
            saveSettings(newSettings);
            applySettings(newSettings);
        });

        // Hide All
        document.getElementById('hideAllBtn').addEventListener('click', () => {
            fields.forEach(field => {
                const checkbox = document.getElementById(`field_${field}`);
                if (checkbox) checkbox.checked = false;
            });
            const newSettings = {};
            fields.forEach(field => {
                const checkbox = document.getElementById(`field_${field}`);
                newSettings[field] = checkbox ? checkbox.checked : false;
            });
            newSettings.doorCount = document.getElementById('doorCountSelect').value;
            saveSettings(newSettings);
            applySettings(newSettings);
        });

        // Make items draggable
        document.querySelectorAll('.data-item, .door-widget').forEach(item => {
            item.addEventListener('mousedown', startDrag);
        });

        function startDrag(e) {
            if (!editMode) return;
            
            // Ignore if clicking on toggle button or resize handle
            if (e.target.classList.contains('toggle-border-btn')) return;
            
            // Check if clicking on resize handle (bottom-right corner)
            const rect = e.currentTarget.getBoundingClientRect();
            const isResizeHandle = (
                e.clientX > rect.right - 20 && 
                e.clientY > rect.bottom - 20
            );
            if (isResizeHandle) return;
            
            draggedElement = e.currentTarget;
            const elemRect = draggedElement.getBoundingClientRect();
            offsetX = e.clientX - elemRect.left;
            offsetY = e.clientY - elemRect.top;
            
            draggedElement.classList.add('dragging');
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            e.preventDefault(); // Prevent text selection while dragging
        }

        function drag(e) {
            if (!draggedElement) return;
            
            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;
            
            draggedElement.style.left = `${x}px`;
            draggedElement.style.top = `${y}px`;
        }

        function stopDrag() {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // Save layout (to URL hash - works across ALL browsers!)
        function saveLayout() {
            const positions = {};
            document.querySelectorAll('.data-item, .door-widget').forEach(item => {
                const id = item.id;
                positions[id] = {
                    left: item.style.left,
                    top: item.style.top,
                    width: item.style.width || 'auto',
                    height: item.style.height || 'auto',
                    borderless: item.classList.contains('borderless-item'),
                    hidden: item.classList.contains('hidden-by-eye'),
                    zIndex: item.style.zIndex || '10'
                };
            });
            
            // Save to localStorage as backup
            localStorage.setItem('itemPositions', JSON.stringify(positions));
            
            // ALSO save to URL hash (this is shared when URL is copied!)
            const encoded = btoa(JSON.stringify(positions));
            const newHash = '#layout=' + encoded;
            
            // Update URL without reload
            if (window.location.hash !== newHash) {
                history.replaceState(null, '', newHash);
                console.log('‚úÖ Layout saved to URL! Copy this URL to OBS!');
            }
        }

        // Load layout (from URL hash OR localStorage)
        function loadLayout() {
            let positions = null;
            
            // Try URL hash first (works across browsers!)
            if (window.location.hash.startsWith('#layout=')) {
                try {
                    const encoded = window.location.hash.substring(8); // Remove '#layout='
                    const decoded = atob(encoded);
                    positions = JSON.parse(decoded);
                    console.log('üìÇ Layout loaded from URL hash');
                } catch (e) {
                    console.log('‚ö†Ô∏è URL hash parse error:', e);
                }
            }
            
            // Fallback: Load from cookies
            if (!positions) {
                const cookieData = getCookie('overlayPositions');
                if (cookieData) {
                    try {
                        positions = JSON.parse(cookieData);
                        console.log('üç™ Layout loaded from cookie');
                    } catch (e) {
                        console.log('‚ö†Ô∏è Cookie parse error');
                    }
                }
            }
            
            // Fallback: Load from localStorage
            if (!positions) {
                const saved = localStorage.getItem('itemPositions');
                if (saved) {
                    positions = JSON.parse(saved);
                    console.log('üíæ Layout loaded from localStorage');
                }
            }
            
            // Apply positions
            if (positions) {
                Object.keys(positions).forEach(id => {
                    const item = document.getElementById(id);
                    if (item) {
                        item.style.left = positions[id].left;
                        item.style.top = positions[id].top;
                        if (positions[id].width && positions[id].width !== 'auto') {
                            item.style.width = positions[id].width;
                        }
                        if (positions[id].height && positions[id].height !== 'auto') {
                            item.style.height = positions[id].height;
                        }
                        // Apply borderless state
                        if (positions[id].borderless) {
                            item.classList.add('borderless-item');
                        } else {
                            item.classList.remove('borderless-item');
                        }
                        // Apply hidden state
                        if (positions[id].hidden) {
                            item.classList.add('hidden-by-eye');
                        } else {
                            item.classList.remove('hidden-by-eye');
                        }
                        // Apply z-index
                        if (positions[id].zIndex) {
                            item.style.zIndex = positions[id].zIndex;
                        }
                    }
                });
            }
        }

        // Door functions
        function getDoorNumber(doorName) {
            const map = {
                'Door Front': 1, 'Door Second': 2, 'Door Third': 3, 'Door Fourth': 4,
                'Door 1': 1, 'Door 2': 2, 'Door 3': 3, 'Door 4': 4
            };
            return map[doorName] || parseInt(doorName.match(/\d+/)?.[0]) || null;
        }

        function createDoorElements(count) {
            const container = document.getElementById('doorsContainer');
            container.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const door = document.createElement('div');
                door.className = 'door-item';
                door.setAttribute('data-door', i);
                door.innerHTML = `
                    <div class="door-label">T√ºr ${i}</div>
                    <div class="door-value">0%</div>
                    <div class="door-bar" style="width: 0%"></div>
                `;
                container.appendChild(door);
            }
        }

        function updateDoor(number, percentage, locked) {
            const door = document.querySelector(`.door-item[data-door="${number}"]`);
            if (!door) return;
            
            door.querySelector('.door-value').textContent = `${Math.round(percentage)}%`;
            door.querySelector('.door-bar').style.width = `${percentage}%`;
            door.querySelector('.door-bar').style.background = locked ? '#ff4444' : '#00ff88';
        }

        // Start polling
        function startPolling() {
            console.log('üé¨ Starting telemetry polling...');
            updateInterval = setInterval(fetchTelemetryData, 200);
            fetchTelemetryData();
        }

        // Fetch data
        async function fetchTelemetryData() {
            try {
                if (!currentVehicle) {
                    const vehiclesResponse = await fetch(`${API_URL}/vehicles`);
                    const vehicles = await vehiclesResponse.json();
                    if (vehicles && vehicles.length > 0) {
                        currentVehicle = vehicles[0];
                    }
                }

                if (!currentVehicle) return;

                // API unterst√ºtzt nicht alle Variablen im vars Parameter
                // Daher rufen wir ALLE Daten ab (AllowedSpeed, Mass, etc. sind nur so verf√ºgbar)
                const url = `${API_URL}/vehicles/${currentVehicle}`;
                const response = await fetch(url);

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const data = await response.json();
                lastUpdate = Date.now();
                updateOverlay(data);
                updateUMGDisplay(data);

            } catch (error) {
                console.error('Failed to fetch telemetry:', error.message);
                currentVehicle = null;
            }
        }

        // Update overlay
        function updateOverlay(data) {
            // Doors
            if (data.Doors && Array.isArray(data.Doors)) {
                const doorCount = parseInt(document.getElementById('doorCountSelect').value);
                const sortedDoors = data.Doors
                    .map(door => ({ door, number: getDoorNumber(door.Name) || 999 }))
                    .sort((a, b) => a.number - b.number)
                    .map(item => item.door);

                const validDoors = sortedDoors.slice(0, doorCount);
                const currentCount = document.querySelectorAll('.door-item').length;
                if (currentCount !== validDoors.length) createDoorElements(validDoors.length);

                validDoors.forEach((door, index) => {
                    let openValue = parseFloat(door.Progress) || 0;
                    if (openValue <= 1.0) openValue = openValue * 100;
                    const locked = door.Locked === "true" || door.Locked === true;
                    const doorNum = getDoorNumber(door.Name) || (index + 1);
                    updateDoor(doorNum, openValue, locked);
                });
            }

            // Speed
            if (data.Speed !== undefined) {
                document.getElementById('value_speed').textContent = `${Math.round(parseFloat(data.Speed) || 0)} km/h`;
            }

            // Gear
            if (data.Gearbox) {
                let gear = 'N';
                if (data.Gearbox.SelectedGear) gear = data.Gearbox.SelectedGear;
                else if (data.Gearbox.Gear !== undefined) gear = data.Gearbox.Gear;
                document.getElementById('value_gear').textContent = gear;
            }

            // Fuel
            if (data.CurrentFuel !== undefined && data.MaxFuel > 0) {
                const fuelPercent = (parseFloat(data.CurrentFuel) / parseFloat(data.MaxFuel)) * 100;
                const elem = document.getElementById('value_fuel');
                elem.textContent = `${Math.round(fuelPercent)}%`;
                elem.className = 'data-value' + (fuelPercent < 20 ? ' danger' : fuelPercent < 50 ? ' warning' : '');
            }

            // Passengers
            if (data.NumOccupiedSeats !== undefined) {
                document.getElementById('value_passengers').textContent = parseInt(data.NumOccupiedSeats) || 0;
            }

            // Model
            if (data.VehicleModel) {
                document.getElementById('value_model').textContent = data.VehicleModel;
            }

            // RPM
            if (data.RPM !== undefined) {
                document.getElementById('value_rpm').textContent = `${Math.round(parseFloat(data.RPM) || 0)} RPM`;
            }

            // Temperature
            if (data.EngineTemperature !== undefined) {
                const temp = Math.round(parseFloat(data.EngineTemperature) || 0);
                const elem = document.getElementById('value_temp');
                elem.textContent = `${temp}¬∞C`;
                elem.className = 'data-value' + (temp > 100 ? ' danger' : temp > 80 ? ' warning' : '');
            }

            // Brake
            if (data.Brake !== undefined) {
                document.getElementById('value_brake').textContent = `${Math.round((parseFloat(data.Brake) || 0) * 100)}%`;
            }

            // Throttle
            if (data.Throttle !== undefined) {
                document.getElementById('value_throttle').textContent = `${Math.round((parseFloat(data.Throttle) || 0) * 100)}%`;
            }

            // Steering
            if (data.Steering !== undefined) {
                document.getElementById('value_steering').textContent = `${Math.round(parseFloat(data.Steering) * 100) || 0}¬∞`;
            }

            // Load
            if (data.Load !== undefined) {
                document.getElementById('value_load').textContent = `${Math.round((parseFloat(data.Load) || 0) * 100)}%`;
            }

            // At Stop
            if (data.IsAtStop !== undefined) {
                const atStop = data.IsAtStop === true || data.IsAtStop === "true";
                const elem = document.getElementById('value_atstop');
                elem.textContent = atStop ? "JA" : "NEIN";
                elem.className = 'data-value' + (atStop ? ' success' : '');
            }

            // Indicator
            if (data.IndicatorState !== undefined) {
                const indicator = parseInt(data.IndicatorState) || 0;
                const text = indicator === 0 ? "AUS" : indicator === -1 ? "‚óÄÔ∏è LINKS" : indicator === 1 ? "‚ñ∂Ô∏è RECHTS" : "‚ö†Ô∏è WARNBLINKER";
                const elem = document.getElementById('value_indicator');
                elem.textContent = text;
                elem.className = 'data-value' + (indicator !== 0 ? ' warning' : '');
            }

            // Wiper
            if (data.WiperLevel !== undefined) {
                const wiper = parseInt(data.WiperLevel) || 0;
                const text = wiper === 0 ? "AUS" : `Stufe ${wiper}`;
                document.getElementById('value_wiper').textContent = text;
            }

            // Lights
            if (data.AllLamps) {
                updateLightValue('headlights', parseFloat(data.AllLamps["LightHeadlight"]) > 0 || parseFloat(data.AllLamps["LightMain"]) > 0);
                updateLightValue('highbeam', parseFloat(data.AllLamps["LightTraveling1"]) > 0);
                updateLightValue('interior', parseFloat(data.AllLamps["Passenger Lights"]) > 0);
                updateLightValue('hazard', parseFloat(data.AllLamps["Warning Light"]) > 0);
            }

            // Status
            if (data.Buttons) {
                const fixingBrake = data.Buttons.find(b => b.Name === "ParkingBrake");
                updateStatusValue('parkbrake', fixingBrake && fixingBrake.State === "Primary");

                updateStatusValue('retarder', data.AllLamps && parseFloat(data.AllLamps["Dashboard Retarder"]) > 0);

                const ignition = data.Buttons.find(b => b.Name === "Fake Ignition");
                updateStatusValue('ignition', ignition && ignition.State === "Start");

                updateStatusValue('cruisecontrol', data.CruiseControlActive === true || data.CruiseControlActive === "true");
                updateStatusValue('lowfuel', data.LowFuelWarning === true || data.LowFuelWarning === "true");
                updateStatusValue('destination', data.DestinationDisplayActive === true || data.DestinationDisplayActive === "true");
            }

            // NEW: Fahrzeug-Info
            if (data.AllowedSpeed !== undefined) {
                document.getElementById('value_allowedspeed').textContent = `${Math.round(parseFloat(data.AllowedSpeed) || 0)} km/h`;
            }

            if (data.Mass !== undefined) {
                const massKg = parseFloat(data.Mass) || 0;
                const massTons = (massKg / 1000).toFixed(1);
                document.getElementById('value_mass').textContent = `${massTons} t`;
            }

            if (data.NumSeats !== undefined) {
                document.getElementById('value_numseats').textContent = parseInt(data.NumSeats) || 0;
            }

            if (data.DirtIntensity !== undefined) {
                const dirt = Math.round((parseFloat(data.DirtIntensity) || 0) * 100);
                const elem = document.getElementById('value_dirtintensity');
                elem.textContent = `${dirt}%`;
                elem.className = 'data-value' + (dirt > 50 ? ' warning' : '');
            }

            // NEW: Motor & Technik
            if (data.EngineStarted !== undefined) {
                const running = data.EngineStarted === true || data.EngineStarted === "true";
                const elem = document.getElementById('value_enginestarted');
                elem.textContent = running ? "L√ÑUFT" : "AUS";
                elem.className = 'data-value' + (running ? ' success' : ' danger');
            }

            if (data.MaxRPM !== undefined) {
                document.getElementById('value_maxrpm').textContent = `${Math.round(parseFloat(data.MaxRPM) || 0)} RPM`;
            }

            if (data.PowerMeter !== undefined) {
                const power = Math.round((parseFloat(data.PowerMeter) || 0) * 100);
                document.getElementById('value_powermeter').textContent = `${power}%`;
            }
        }

        function updateLightValue(name, isOn) {
            const elem = document.getElementById(`value_${name}`);
            elem.textContent = isOn ? "AN" : "AUS";
            elem.className = 'data-value' + (isOn ? ' success' : '');
        }

        function updateStatusValue(name, isOn) {
            const elem = document.getElementById(`value_${name}`);
            elem.textContent = isOn ? "AN" : "AUS";
            elem.className = 'data-value' + (isOn ? ' success' : '');
        }

        // UMG Display Update
        function updateUMGDisplay(data) {
            if (!data.UMG) return;
            
            // Driver Display
            if (data.UMG["Driver Display"]) {
                const umgUrl = `${API_URL}${data.UMG["Driver Display"]}/image?t=${Date.now()}`;
                const umgImage = document.getElementById('umg_image');
                if (umgImage && umgImage.src !== umgUrl) {
                    umgImage.src = umgUrl;
                }
            }

            // ATRON Boardcomputer
            if (data.UMG["Atron"]) {
                const atronUrl = `${API_URL}${data.UMG["Atron"]}/image?t=${Date.now()}`;
                const atronImage = document.getElementById('atron_image');
                if (atronImage && atronImage.src !== atronUrl) {
                    atronImage.src = atronUrl;
                }
            }
        }

        // Settings
        function loadSettings() {
            const settings = {
                doorCount: localStorage.getItem('doorCount') || '3'
            };
            fields.forEach(field => {
                settings[field] = localStorage.getItem(`field_${field}`) !== 'false';
            });
            return settings;
        }

        function saveSettings(settings) {
            localStorage.setItem('doorCount', settings.doorCount);
            fields.forEach(field => {
                localStorage.setItem(`field_${field}`, settings[field]);
            });
        }

        function applySettings(settings) {
            document.getElementById('doorCountSelect').value = settings.doorCount;
            createDoorElements(parseInt(settings.doorCount));

            fields.forEach(field => {
                const checkbox = document.getElementById(`field_${field}`);
                if (checkbox) checkbox.checked = settings[field];

                if (field === 'doors') {
                    const widget = document.getElementById('widget_doors');
                    if (widget) {
                        if (settings[field]) widget.classList.remove('hidden');
                        else widget.classList.add('hidden');
                    }
                } else {
                    const item = document.getElementById(`item_${field}`);
                    if (item) {
                        if (settings[field]) item.classList.remove('hidden');
                        else item.classList.add('hidden');
                    }
                }
            });
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üé¨ TheBus Fully Custom Overlay starting...');

            // Check for OBS mode URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const isOBSMode = urlParams.get('obs') === 'true';

            if (isOBSMode) {
                document.body.classList.add('obs-mode');
                console.log('üìπ OBS Mode aktiviert - Alle Controls versteckt');
                document.getElementById('obsInfoBox').style.display = 'none';
                
                // OBS: Load layout from URL hash on startup
                loadLayout();
                
                // No auto-refresh needed - layout is in URL!
                console.log('üí° Layout ist in der URL gespeichert - kein Polling n√∂tig!');
            } else {
                // Add mode indicator
                const indicator = document.createElement('div');
                indicator.className = 'mode-indicator';
                indicator.textContent = '‚öôÔ∏è EDIT MODE';
                document.body.appendChild(indicator);
                console.log('‚úèÔ∏è Edit Mode - Controls sichtbar beim Hover');
                
                // Copy URL button (in OBS Info Box)
                document.getElementById('copyUrlBtn').addEventListener('click', () => {
                    const currentPath = window.location.href.split('?')[0].split('#')[0];
                    const latestHash = window.location.hash || '';
                    const latestObsUrl = currentPath + '?obs=true' + latestHash;
                    navigator.clipboard.writeText(latestObsUrl).then(() => {
                        const btn = document.getElementById('copyUrlBtn');
                        btn.textContent = '‚úÖ URL mit Layout kopiert!';
                        btn.classList.add('copied');
                        setTimeout(() => {
                            btn.textContent = 'üìã URL Kopieren';
                            btn.classList.remove('copied');
                        }, 3000);
                    });
                });
            }

            const settings = loadSettings();
            applySettings(settings);
            loadLayout();
            loadBorderlessStates();
            
            // Add toggle buttons to all items
            document.querySelectorAll('.data-item, .door-widget').forEach(item => {
                // Border toggle button
                if (!item.querySelector('.toggle-border-btn')) {
                    const borderBtn = document.createElement('button');
                    borderBtn.className = 'toggle-border-btn';
                    borderBtn.textContent = 'üìã';
                    borderBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleItemBorder(item.id);
                    };
                    item.appendChild(borderBtn);
                }
                
                // Eye toggle button
                if (!item.querySelector('.toggle-eye-btn')) {
                    const eyeBtn = document.createElement('button');
                    eyeBtn.className = 'toggle-eye-btn';
                    const isHidden = item.classList.contains('hidden-by-eye');
                    eyeBtn.textContent = isHidden ? 'üö´' : 'üëÅÔ∏è';
                    if (isHidden) eyeBtn.classList.add('hidden-item');
                    eyeBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleItemVisibility(item.id);
                    };
                    item.appendChild(eyeBtn);
                }
                
                // Z-Index up button
                if (!item.querySelector('.z-index-up-btn')) {
                    const upBtn = document.createElement('button');
                    upBtn.className = 'z-index-up-btn';
                    upBtn.textContent = '‚¨ÜÔ∏è';
                    upBtn.onclick = (e) => {
                        e.stopPropagation();
                        moveItemUp(item.id);
                    };
                    item.appendChild(upBtn);
                }
                
                // Z-Index down button
                if (!item.querySelector('.z-index-down-btn')) {
                    const downBtn = document.createElement('button');
                    downBtn.className = 'z-index-down-btn';
                    downBtn.textContent = '‚¨áÔ∏è';
                    downBtn.onclick = (e) => {
                        e.stopPropagation();
                        moveItemDown(item.id);
                    };
                    item.appendChild(downBtn);
                }
            });
            
            // Apply saved background state
            if (showBackground) {
                document.body.classList.add('show-bg');
                document.getElementById('toggleBgBtn').textContent = 'üñºÔ∏è Hintergrund: AN';
                document.getElementById('toggleBgBtn').classList.add('active');
            }
            
            // Update resolution info
            updateResolutionInfo();

            // Settings panel
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsPanel').style.display = 'block';
            });

            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.getElementById('settingsPanel').style.display = 'none';
            });

            document.getElementById('saveBtn').addEventListener('click', () => {
                const newSettings = {
                    doorCount: document.getElementById('doorCountSelect').value
                };
                fields.forEach(field => {
                    const checkbox = document.getElementById(`field_${field}`);
                    newSettings[field] = checkbox ? checkbox.checked : true;
                });
                saveSettings(newSettings);
                applySettings(newSettings);
                document.getElementById('settingsPanel').style.display = 'none';
            });

            startPolling();
        });

        window.addEventListener('beforeunload', () => {
            if (updateInterval) clearInterval(updateInterval);
            if (editMode) saveLayout();
        });

        // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        // DESKTOP MODE - Electron Integration
        // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        
        if (window.electron && window.electron.isElectron) {
            console.log('üñ•Ô∏è DESKTOP MODE aktiviert!');
            
            // Im Desktop Mode: Immer Edit Mode aktiv
            editMode = true;
            
            // Alle Items sind draggable
            document.querySelectorAll('.data-item, .door-widget, .speed-gauge, .temperature-gauge').forEach(item => {
                item.style.cursor = 'move';
            });
            
            // Context Menu f√ºr Desktop
            const contextMenu = document.getElementById('contextMenu');
            if (contextMenu) {
                document.addEventListener('contextmenu', (e) => {
                    const target = e.target.closest('.data-item, .door-widget, .speed-gauge, .temperature-gauge');
                    if (target) {
                        e.preventDefault();
                        contextMenu.style.display = 'block';
                        contextMenu.style.left = e.clientX + 'px';
                        contextMenu.style.top = e.clientY + 'px';
                    }
                });

                document.addEventListener('click', () => {
                    if (contextMenu) contextMenu.style.display = 'none';
                });
            }

            // Close Button funktioniert
            window.closeOverlay = function() {
                if (window.electron && window.electron.closeApp) {
                    window.electron.closeApp();
                }
            };

            console.log('‚úÖ Desktop Mode voll funktionsf√§hig - Drag & Drop aktiviert');
        }
    </script>
</body>
</html>
