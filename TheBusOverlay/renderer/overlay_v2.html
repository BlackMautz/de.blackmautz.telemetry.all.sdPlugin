<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheBus Desktop Overlay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            color: #fff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        /* Telemetrie Items */
        .data-item {
            position: absolute;
            background: rgba(20, 20, 30, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(102, 126, 234, 0.6);
            border-radius: 12px;
            padding: 15px;
            min-width: 150px;
            cursor: move;
            user-select: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            transition: border-color 0.2s, transform 0.2s;
        }

        .data-item:hover {
            border-color: rgba(102, 126, 234, 1);
            transform: scale(1.02);
        }

        .data-item-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-item-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .data-item-unit {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-left: 5px;
        }

        /* Context Menu */
        .context-menu {
            display: none;
            position: fixed;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 8px;
            padding: 4px;
            z-index: 100000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            min-width: 150px;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            font-size: 14px;
        }

        .context-menu-item:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        .context-menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 4px 0;
        }

        /* Connection Status */
        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            background: rgba(20, 20, 30, 0.9);
            border: 2px solid rgba(239, 68, 68, 0.6);
            border-radius: 8px;
            font-size: 12px;
            color: rgba(239, 68, 68, 1);
        }

        #connection-status.connected {
            border-color: rgba(34, 197, 94, 0.6);
            color: rgba(34, 197, 94, 1);
        }

        /* Warning Indicators */
        .warning {
            border-color: rgba(251, 191, 36, 0.8) !important;
        }

        .warning .data-item-value {
            color: #fbbf24 !important;
        }

        .critical {
            border-color: rgba(239, 68, 68, 0.8) !important;
        }

        .critical .data-item-value {
            color: #ef4444 !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connection-status">⚠ Nicht verbunden</div>

    <!-- Telemetrie Items (werden dynamisch erstellt) -->
    <div id="telemetry-container"></div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="toggleElement()">Ausblenden</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="resetPositions()">Positionen zurücksetzen</div>
        <div class="context-menu-item" onclick="saveLayout()">Layout speichern</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="closeOverlay()">Overlay schließen</div>
    </div>

    <script>
        const API_URL = 'http://localhost:37337';
        
        let draggedElement = null;
        let offsetX = 0;
        let offsetY = 0;
        let currentContextTarget = null;
        let telemetryData = {};
        let isConnected = false;

        // Telemetrie Items Konfiguration
        const telemetryItems = [
            { id: 'speed', label: 'Geschwindigkeit', unit: 'km/h', field: 'speed', x: 100, y: 100 },
            { id: 'fuel', label: 'Kraftstoff', unit: '%', field: 'fuel_percent', x: 100, y: 200 },
            { id: 'passengers', label: 'Fahrgäste', unit: '', field: 'passengers', x: 100, y: 300 },
            { id: 'rpm', label: 'Drehzahl', unit: 'RPM', field: 'rpm', x: 300, y: 100 },
            { id: 'gear', label: 'Gang', unit: '', field: 'gear', x: 300, y: 200 },
            { id: 'temp', label: 'Motor-Temp', unit: '°C', field: 'engine_temp', x: 300, y: 300 },
        ];

        // Initialisierung
        function init() {
            // Erstelle Telemetrie Items
            telemetryItems.forEach(item => {
                createTelemetryItem(item);
            });

            // Lade gespeicherte Positionen
            loadLayout();

            // Event Listeners
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('contextmenu', onContextMenu);
            document.addEventListener('click', hideContextMenu);

            // Starte Telemetrie Update
            setInterval(updateTelemetry, 500);
            updateTelemetry(); // Erste Abfrage sofort
        }

        // Telemetrie Item erstellen
        function createTelemetryItem(config) {
            const div = document.createElement('div');
            div.className = 'data-item';
            div.id = `item-${config.id}`;
            div.style.left = `${config.x}px`;
            div.style.top = `${config.y}px`;
            div.dataset.field = config.field;
            
            div.innerHTML = `
                <div class="data-item-label">${config.label}</div>
                <div class="data-item-value" id="value-${config.id}">--</div>
                <span class="data-item-unit">${config.unit}</span>
            `;

            div.addEventListener('mousedown', onMouseDown);
            document.getElementById('telemetry-container').appendChild(div);
        }

        // Drag & Drop
        function onMouseDown(e) {
            if (e.button !== 0) return; // Nur linke Maustaste

            draggedElement = e.currentTarget;
            const rect = draggedElement.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            draggedElement.style.zIndex = 1000;
            e.preventDefault();
        }

        function onMouseMove(e) {
            if (!draggedElement) return;

            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;

            draggedElement.style.left = `${x}px`;
            draggedElement.style.top = `${y}px`;
        }

        function onMouseUp(e) {
            if (draggedElement) {
                draggedElement.style.zIndex = '';
                saveLayout(); // Auto-save beim Loslassen
                draggedElement = null;
            }
        }

        // Context Menu
        function onContextMenu(e) {
            e.preventDefault();
            
            const menu = document.getElementById('contextMenu');
            const target = e.target.closest('.data-item');
            
            if (target) {
                currentContextTarget = target;
                menu.style.display = 'block';
                menu.style.left = `${e.clientX}px`;
                menu.style.top = `${e.clientY}px`;
            }
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }

        function toggleElement() {
            if (currentContextTarget) {
                currentContextTarget.style.display = 'none';
            }
            hideContextMenu();
        }

        // Telemetrie Daten abrufen
        async function updateTelemetry() {
            try {
                const response = await fetch(`${API_URL}/api/v1/telemetry`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    telemetryData = await response.json();
                    updateDisplay();
                    setConnected(true);
                } else {
                    setConnected(false);
                }
            } catch (error) {
                setConnected(false);
            }
        }

        // Display aktualisieren
        function updateDisplay() {
            telemetryItems.forEach(item => {
                const valueEl = document.getElementById(`value-${item.id}`);
                const container = document.getElementById(`item-${item.id}`);
                
                if (!valueEl || !container) return;

                let value = getNestedValue(telemetryData, item.field);
                
                // Formatierung
                if (value !== undefined && value !== null) {
                    if (typeof value === 'number') {
                        value = value.toFixed(item.unit === '%' || item.unit === 'km/h' ? 0 : 1);
                    }
                    valueEl.textContent = value;

                    // Warnungen
                    container.classList.remove('warning', 'critical');
                    if (item.id === 'fuel') {
                        const fuelPercent = parseFloat(value);
                        if (fuelPercent < 10) container.classList.add('critical');
                        else if (fuelPercent < 25) container.classList.add('warning');
                    }
                } else {
                    valueEl.textContent = '--';
                }
            });
        }

        // Nested Object Value holen
        function getNestedValue(obj, path) {
            // Spezielle Berechnungen
            if (path === 'fuel_percent') {
                const current = obj.fuel?.current || 0;
                const max = obj.fuel?.max || 1;
                return (current / max * 100);
            }
            if (path === 'passengers') {
                return obj.passengers?.occupied_seats || 0;
            }
            if (path === 'speed') {
                return obj.speed?.current || 0;
            }
            if (path === 'rpm') {
                return obj.engine?.rpm || 0;
            }
            if (path === 'gear') {
                return obj.gearbox?.current_gear || 'N';
            }
            if (path === 'engine_temp') {
                return obj.engine?.temperature || 0;
            }

            // Fallback: direkte Pfad-Abfrage
            return path.split('.').reduce((o, i) => o?.[i], obj);
        }

        // Connection Status
        function setConnected(connected) {
            if (isConnected === connected) return;
            isConnected = connected;

            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.textContent = '✓ Verbunden';
                statusEl.classList.add('connected');
            } else {
                statusEl.textContent = '⚠ Nicht verbunden';
                statusEl.classList.remove('connected');
            }
        }

        // Layout speichern/laden
        function saveLayout() {
            const layout = {};
            telemetryItems.forEach(item => {
                const el = document.getElementById(`item-${item.id}`);
                if (el) {
                    layout[item.id] = {
                        x: parseInt(el.style.left),
                        y: parseInt(el.style.top),
                        visible: el.style.display !== 'none'
                    };
                }
            });
            localStorage.setItem('overlay_layout', JSON.stringify(layout));
        }

        function loadLayout() {
            const saved = localStorage.getItem('overlay_layout');
            if (!saved) return;

            try {
                const layout = JSON.parse(saved);
                Object.keys(layout).forEach(id => {
                    const el = document.getElementById(`item-${id}`);
                    if (el && layout[id]) {
                        el.style.left = `${layout[id].x}px`;
                        el.style.top = `${layout[id].y}px`;
                        if (!layout[id].visible) el.style.display = 'none';
                    }
                });
            } catch (e) {
                console.error('Fehler beim Laden des Layouts:', e);
            }
        }

        function resetPositions() {
            telemetryItems.forEach(item => {
                const el = document.getElementById(`item-${item.id}`);
                if (el) {
                    el.style.left = `${item.x}px`;
                    el.style.top = `${item.y}px`;
                    el.style.display = 'block';
                }
            });
            saveLayout();
            hideContextMenu();
        }

        // Overlay schließen
        function closeOverlay() {
            if (window.electron) {
                window.electron.closeApp();
            } else {
                window.close();
            }
        }

        // Start
        init();
    </script>
</body>
</html>
